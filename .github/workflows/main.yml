name: System Pro Engine (Decompiler)

on:
  push:
    paths:
      - 'uploads/**.apk' # جب بھی اپ لوڈز فولڈر میں APK آئے گی، انجن چل پڑے گا

jobs:
  decompile:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Install JADX Decompiler
        run: |
          sudo apt-get update
          wget https://github.com/skylot/jadx/releases/download/v1.4.7/jadx-1.4.7.zip
          unzip jadx-1.4.7.zip -d jadx
          echo "$(pwd)/jadx/bin" >> $GITHUB_PATH

      - name: Run Decompiler
        run: |
          mkdir -p output
          # اپ لوڈ کی گئی تازہ ترین فائل کو ڈی کمپائل کریں
          jadx -d output/src uploads/*.apk

      - name: Prepare JSON for System Pro
        run: |
          # یہ اسکرپٹ تمام فائلوں کو ایک JSON میں جمع کرے گا تاکہ ایپ اسے پڑھ سکے
          python3 -c "
          import os, json
          data = {'html': '', 'css': '', 'js': '', 'kotlin': ''}
          for root, dirs, files in os.walk('output/src'):
              for file in files:
                  path = os.path.join(root, file)
                  if file.endswith('.kt'):
                      with open(path, 'r') as f: data['kotlin'] += f.read() + '\n'
                  elif file.endswith('.html'):
                      with open(path, 'r') as f: data['html'] += f.read() + '\n'
                  elif file.endswith('.css'):
                      with open(path, 'r') as f: data['css'] += f.read() + '\n'
                  elif file.endswith('.js'):
                      with open(path, 'r') as f: data['js'] += f.read() + '\n'
          with open('results.json', 'w') as f: json.dump(data, f)
          "

      - name: Upload Results
        uses: actions/upload-artifact@v3
        with:
          name: decompile-results
          path: results.json
